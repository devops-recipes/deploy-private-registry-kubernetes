jobs:

  - name: dprk-pod-def
    type: manifest
    steps:
      - IN: dprk_app_img
      - TASK: managed

  - name: dprk_provision_cluster
    type: runSh
    steps:
      - IN: dprk_gitRepo
        # manually trigger the job and not on every commit to the repository
        switch: off
      - IN: dprk_dockerhub
      - IN: dprk_kube_params
      - IN: dprk_cliConfig
        scopes:
          - gke
      - IN: dprk-pod-def
      - TASK:
        - script: |
            # create the cluster on GKE
            $DPRK_GITREPO_PATH/gitRepo/provision_gke_cluster.sh $DPRK_CLUSTER_NAME $DPRK_CLUSTER_NUM_NODES $DPRK_CLUSTER_MACHINE_TYPE $DPRK_CLICONFIG_POINTER_REGION

            # Delete and create the secret
            gcloud container clusters get-credentials $DPRK_CLUSTER_NAME --zone $DPRK_CLICONFIG_POINTER_REGION
            kubectl delete secret $DPRK_SECRET_KEY_NAME 2>/dev/null || echo "secret does not exist"
            kubectl create secret docker-registry $DPRK_SECRET_KEY_NAME --docker-username="$DPRK_DOCKERHUB_INTEGRATION_USERNAME" --docker-password="$DPRK_DOCKERHUB_INTEGRATION_PASSWORD" --docker-email="$DPRK_DOCKERHUB_INTEGRATION_EMAIL" --docker-server="$DPRK_DOCKERHUB_INTEGRATION_URL"/

  - name: dprk-pod-deploy
    type: deploy
    steps:
      - IN: dprk_imagepull_secrets
      - IN: dprk_cluster
      - IN: dprk-pod-def
      - IN: dprk_provision_cluster

  - name: dprk_provision_lb
    type: provision
    steps:
      - IN: dprk_lb
      - IN: dprk-pod-deploy
